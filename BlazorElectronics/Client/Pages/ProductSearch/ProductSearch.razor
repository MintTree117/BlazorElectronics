@page "/{category}/search/{searchText}"
@page "/search/{searchText}"
@page "/{category}"
@inject IProductServiceClient ProductService;
@inject NavigationManager NavigationManager;
@implements IDisposable
@using BlazorElectronics.Client.Services.Products
@using System.Collections.Specialized
@using System.Reflection
@using System.Text
@using System.Web
@using BlazorElectronics.Shared.DtosInbound.Products

<span>_@_debugMessage</span>
<span>@_nullSearch</span>
<ProductList></ProductList>

@code {
    [Parameter]
    public string? Category { get; set; }
    [Parameter]
    public string? SearchText { get; set; }

    string _debugMessage = string.Empty;
    string _nullSearch = string.Empty;


    protected override void OnInitialized()
    {
        ProductService.ProductSearchNullabillityTest += NullTest;
    }
    public void Dispose()
    {
        ProductService.ProductSearchNullabillityTest -= NullTest;
    }

    void NullTest( string s )
    {
        _nullSearch = s;
    }
    
    protected override async Task OnParametersSetAsync()
    {
        Uri uri = NavigationManager.ToAbsoluteUri( NavigationManager.Uri );
        NameValueCollection queryParameters = HttpUtility.ParseQueryString( uri.Query );

        ProductSearchRequest_DTO request = MapSearchQueryParameters( queryParameters );

        if ( Category != null && SearchText != null )
        {
            ProductService.UpdateSearchCategory( Category );
            ProductService.UpdateSearchText( SearchText );
            await ProductService.SearchProductsByCategoryAndText( Category, SearchText, request );
        }
        else if ( Category != null )
        {
            ProductService.UpdateSearchCategory( Category );
            await ProductService.SearchProductsByCategory( Category, request );
        }
        else if ( SearchText != null )
        {
            ProductService.UpdateSearchText( SearchText );
            await ProductService.SearchProductsByText( SearchText, request );
        }
        else throw new Exception( "No valid input parameters provided for product search!" );

        StateHasChanged();
    }

    ProductSearchRequest_DTO MapSearchQueryParameters( NameValueCollection queryParameters )
    {
        var filtersDTO = new ProductSearchRequest_DTO();
        Type type = typeof( ProductSearchRequest_DTO );

        foreach ( string? key in queryParameters.AllKeys )
        {
            if ( string.IsNullOrEmpty( key ) )
                continue;

            var parsedKeyBuilder = new StringBuilder();
            parsedKeyBuilder.Append( char.ToUpper( key[ 0 ] ) );

            for ( int i = 1; i < key.Length; i++ )
            {
                if ( key[ i ] == '-' )
                    continue;
                if ( key[ i - 1 ] == '-' )
                {
                    parsedKeyBuilder.Append( char.ToUpper( key[ i ] ) );
                    continue;
                }
                parsedKeyBuilder.Append( char.ToLower( key[ i ] ) );
            }

            string filterName = parsedKeyBuilder.ToString();
            var stringValue = queryParameters[ key ];
            PropertyInfo? propertyInfo = type.GetProperty( filterName );

            if ( propertyInfo != null )
            {
                var convertedValue = Convert.ChangeType( stringValue, propertyInfo.PropertyType );
                propertyInfo.SetValue( filtersDTO, convertedValue );
                continue;
            }

            filtersDTO.SpecFilters.Add( new ProductSpecFilter_DTO {
                SpecName = key,
                SpecValue = Convert.ChangeType( stringValue, typeof( object ) )
            } );
        }

        return filtersDTO;
    }
}